<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redis Management - Security Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../static/style.css">
</head>
<body class="bg-dark-custom text-light">
    <div class="container py-4">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="header-title">
                    <i class="fas fa-database me-3"></i>
                    Redis Management
                </h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ url_for('index') }}" class="text-warning">Dashboard</a></li>
                        <li class="breadcrumb-item active text-light">Redis Management</li>
                    </ol>
                </nav>
            </div>
            <div>
                <a href="{{ url_for('redis_management') }}" class="btn btn-outline-warning me-2">
                    <i class="fas fa-sync-alt me-2"></i>Update
                </a>
                <a href="{{ url_for('export_redis') }}" class="btn btn-outline-info" target="_blank">
                    <i class="fas fa-download me-2"></i>Export JSON
                </a>
            </div>
        </div>


        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                        <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' }} me-2"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}


        <div class="row mb-4">
            <div class="col-12">
                <div class="card card-custom">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>
                            Redis statistics
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <div class="stat-card p-3 rounded text-center">
                                    <i class="fas fa-users text-warning fs-2"></i>
                                    <h4 class="mt-2">{{ redis_stats.total_clients }}</h4>
                                    <small class="text-muted">Total Clients</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card p-3 rounded text-center">
                                    <i class="fas fa-user-check text-success fs-2"></i>
                                    <h4 class="mt-2">{{ redis_stats.online_clients }}</h4>
                                    <small class="text-muted">Online Clients</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card p-3 rounded text-center">
                                    <i class="fas fa-comments text-info fs-2"></i>
                                    <h4 class="mt-2">{{ redis_stats.total_rooms }}</h4>
                                    <small class="text-muted">Total Rooms</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card p-3 rounded text-center">
                                    <i class="fas fa-envelope text-primary fs-2"></i>
                                    <h4 class="mt-2">{{ redis_stats.total_private_messages + redis_stats.total_room_messages }}</h4>
                                    <small class="text-muted">Total Messages</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <div class="d-flex justify-content-between">
                                    <span>Active Rooms:</span>
                                    <strong class="text-success">{{ redis_stats.active_rooms }}</strong>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex justify-content-between">
                                    <span>Private Messages:</span>
                                    <strong class="text-info">{{ redis_stats.total_private_messages }}</strong>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex justify-content-between">
                                    <span>Database Keys:</span>
                                    <strong class="text-warning">{{ redis_stats.database_keys }}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">

            <div class="col-lg-8">
                <div class="card card-custom">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-eye me-2"></i>
                            Redis Data
                        </h5>
                    </div>
                    <div class="card-body">

                        <div class="mb-4">
                            <h6 class="text-warning">
                                <i class="fas fa-users me-2"></i>
                                Clients ({{ redis_data.clients|length }})
                            </h6>
                            {% if redis_data.clients %}
                                <div class="json-viewer p-3">
                                    <pre class="text-light mb-0"><code>{{ redis_data.clients | tojson(indent=2) }}</code></pre>
                                </div>
                            {% else %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    No Client Registered
                                </div>
                            {% endif %}
                        </div>


                        <div class="mb-4">
                            <h6 class="text-info">
                                <i class="fas fa-comments me-2"></i>
                                Rooms ({{ redis_data.rooms|length }})
                            </h6>
                            {% if redis_data.rooms %}
                                <div class="json-viewer p-3">
                                    <pre class="text-light mb-0"><code>{{ redis_data.rooms | tojson(indent=2) }}</code></pre>
                                </div>
                            {% else %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    No room active
                                </div>
                            {% endif %}
                        </div>


                        <div class="mb-4">
                            <h6 class="text-primary">
                                <i class="fas fa-envelope me-2"></i>
                                Private messages ({{ redis_data.private_messages|length }})
                            </h6>
                            {% if redis_data.private_messages %}
                                <div class="json-viewer p-3">
                                    <pre class="text-light mb-0"><code>{{ redis_data.private_messages | tojson(indent=2) }}</code></pre>
                                </div>
                            {% else %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    No private messages
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>


            <div class="col-lg-4">
                <div class="card card-custom">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-tools me-2"></i>
                            Control Panel
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="danger-zone">
                            <h6 class="text-danger mb-3">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Danger Zone
                            </h6>
                            <p class="small text-muted mb-3">
                                The following operations will permanently delete data. Proceed with caution.
                            </p>


                            <div class="mb-3">
                                <button type="button" class="btn btn-danger-custom btn-sm w-100" data-action="all">
                                    <i class="fas fa-trash-alt me-2"></i>
                                    Clean Everything
                                    <span class="loading spinner-border spinner-border-sm ms-2" role="status"></span>
                                </button>
                                <small class="text-muted d-block mt-1">Delete all data from the database</small>
                            </div>


                            <div class="mb-3">
                                <button type="button" class="btn btn-outline-danger btn-sm w-100" data-action="clients">
                                    <i class="fas fa-users me-2"></i>
                                    Clean Clients
                                    <span class="loading spinner-border spinner-border-sm ms-2" role="status"></span>
                                </button>
                                <small class="text-muted d-block mt-1">Delete Clients data only</small>
                            </div>


                            <div class="mb-3">
                                <button type="button" class="btn btn-outline-danger btn-sm w-100" data-action="rooms">
                                    <i class="fas fa-comments me-2"></i>
                                    Clean Rooms
                                    <span class="loading spinner-border spinner-border-sm ms-2" role="status"></span>
                                </button>
                                <small class="text-muted d-block mt-1">Delete all rooms and messages</small>
                            </div>


                            <div class="mb-0">
                                <button type="button" class="btn btn-outline-danger btn-sm w-100" data-action="private_messages">
                                    <i class="fas fa-envelope me-2"></i>
                                    Clean Private Messages
                                    <span class="loading spinner-border spinner-border-sm ms-2" role="status"></span>
                                </button>
                                <small class="text-muted d-block mt-1">Delete private messages only</small>
                            </div>
                        </div>


                        <div class="mt-4">
                            <h6 class="text-success mb-3">
                                <i class="fas fa-bolt me-2"></i>
                                Quick Actions
                            </h6>
                            
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-outline-success btn-sm" onclick="location.reload()">
                                    <i class="fas fa-sync-alt me-2"></i>
                                    Update data
                                </button>
                                
                                <a href="{{ url_for('export_redis') }}" class="btn btn-outline-info btn-sm" target="_blank">
                                    <i class="fas fa-download me-2"></i>
                                    Backup JSON
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark border-danger">
                <div class="modal-header border-danger">
                    <h5 class="modal-title text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Confirm Operation
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-warning mb-3">
                        <i class="fas fa-warning me-2"></i>
                        Are you sure you want to proceed with this operation?
                    </p>
                    <p id="confirmText" class="text-light"></p>
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <strong>Warning:</strong> This operation cannot be undone!
                    </div>
                </div>
                <div class="modal-footer border-danger">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmButton">
                        <i class="fas fa-check me-2"></i>Confirm
                        <span class="spinner-border spinner-border-sm ms-2 d-none" role="status"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
            const confirmButton = document.getElementById('confirmButton');
            const confirmText = document.getElementById('confirmText');
            let currentAction = '';
            
            const actionTexts = {
                'all': 'This will delete ALL data from the Redis database, including customers, rooms, and messages.',
                'clients': 'This will delete all registered customer data.',
                'rooms': 'This will delete all rooms and related messages.',
                'private_messages': 'This will delete all private messages.'
            };


            document.querySelectorAll('[data-action]').forEach(button => {
                button.addEventListener('click', function() {
                    currentAction = this.dataset.action;
                    confirmText.textContent = actionTexts[currentAction];
                    confirmModal.show();
                });
            });


            confirmButton.addEventListener('click', function() {
                if (!currentAction) return;
                
                const spinner = confirmButton.querySelector('.spinner-border');
                const buttonText = confirmButton.querySelector('i').nextSibling;
                

                spinner.classList.remove('d-none');
                confirmButton.disabled = true;
                

                const originalButton = document.querySelector(`[data-action="${currentAction}"]`);
                const originalSpinner = originalButton.querySelector('.loading');
                originalSpinner.classList.add('show');
                originalButton.disabled = true;


                const formData = new FormData();
                formData.append('clear_type', currentAction);


                fetch('{{ url_for("clear_redis") }}', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {

                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {

                        alert('Errore: ' + data.message);
                        

                        spinner.classList.add('d-none');
                        confirmButton.disabled = false;
                        originalSpinner.classList.remove('show');
                        originalButton.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Errore di rete: ' + error.message);
                    
    
                    spinner.classList.add('d-none');
                    confirmButton.disabled = false;
                    originalSpinner.classList.remove('show');
                    originalButton.disabled = false;
                });

                confirmModal.hide();
            });
        });
    </script>
</body>
</html>