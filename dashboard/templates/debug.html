<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="../static/style.css">
</head>
<body class="bg-dark-custom">
    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex align-items-center mb-4">
                    <i class="fas fa-bug icon-large me-3"></i>
                    <h2 class="header-title mb-0">Debug & Diagnostics System</h2>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card card-custom">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-server me-2"></i>
                            System Information
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <strong>Current Directory:</strong>
                            </div>
                            <div class="col-6">
                                <code class="text-warning">{{ debug_info.current_directory }}</code>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-6">
                                <strong>Timestamp:</strong>
                            </div>
                            <div class="col-6">
                                <span id="current-time" class="text-info"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card card-custom">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-database me-2"></i>
                            Redis Status
                            {% if debug_info.redis_available %}
                            <span class="status-badge status-online">Online</span>
                            {% else %}
                            <span class="status-badge status-offline">Offline</span>
                            {% endif %}
                        </h4>
                    </div>
                    <div class="card-body">
                        {% if debug_info.redis_available %}
                            {% if debug_info.redis_error %}
                            <div class="alert alert-warning mt-2">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Redis Error: {{ debug_info.redis_error }}
                            </div>
                            {% else %}
                            <div class="row mb-2">
                                <div class="col-8"><strong>Database Keys:</strong></div>
                                <div class="col-4"><span class="badge bg-primary">{{ debug_info.redis_info.database_keys }}</span></div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-8"><strong>Client Online:</strong></div>
                                <div class="col-4"><span class="badge bg-success">{{ debug_info.redis_info.online_clients }}</span></div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-8"><strong>Total Clients:</strong></div>
                                <div class="col-4"><span class="badge bg-info">{{ debug_info.redis_info.total_clients }}</span></div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-8"><strong>Active Rooms:</strong></div>
                                <div class="col-4"><span class="badge bg-warning">{{ debug_info.redis_info.active_rooms }}</span></div>
                            </div>
                            {% endif %}
                        {% else %}
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Redis not available
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="card card-custom">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-file-alt me-2"></i>
                            System File Status
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div class="card bg-dark border-secondary">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">
                                            <i class="fas fa-shield-alt me-2"></i>
                                            Firewall Rules
                                        </h6>
                                        {% if debug_info.firewall_rules_exists and debug_info.firewall_rules_readable %}
                                        <span class="badge bg-success">OK</span>
                                        {% else %}
                                        <span class="badge bg-danger">ERROR</span>
                                        {% endif %}
                                    </div>
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Exists:</span>
                                            <i class="fas {{ 'fa-check text-success' if debug_info.firewall_rules_exists else 'fa-times text-danger' }}"></i>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Readable:</span>
                                            <i class="fas {{ 'fa-check text-success' if debug_info.firewall_rules_readable else 'fa-times text-danger' }}"></i>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>Size:</span>
                                            <span class="text-warning">{{ debug_info.firewall_rules_size }} bytes</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4 mb-3">
                                <div class="card bg-dark border-secondary">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">
                                            <i class="fas fa-file-alt me-2"></i>
                                            Firewall Log
                                        </h6>
                                        {% if debug_info.firewall_log_exists and debug_info.firewall_log_readable %}
                                        <span class="badge bg-success">OK</span>
                                        {% else %}
                                        <span class="badge bg-danger">ERROR</span>
                                        {% endif %}
                                    </div>
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Exists:</span>
                                            <i class="fas {{ 'fa-check text-success' if debug_info.firewall_log_exists else 'fa-times text-danger' }}"></i>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Readable:</span>
                                            <i class="fas {{ 'fa-check text-success' if debug_info.firewall_log_readable else 'fa-times text-danger' }}"></i>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>Size:</span>
                                            <span class="text-warning">{{ debug_info.firewall_log_size }} bytes</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function refreshDebug(){ location.reload(); }
        
        function copyToClipboard() {
            const jsonData = document.getElementById('json-data');
            navigator.clipboard.writeText(jsonData.textContent).then(function() {

                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check me-1"></i>Copiato!';
                btn.classList.add('btn-success');
                btn.classList.remove('btn-outline-light');
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-light');
                }, 2000);
            });
        }
        
        function downloadDebugReport() {
            const debugData = document.getElementById('json-data').textContent;
            const blob = new Blob([debugData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'debug-report-' + new Date().toISOString().slice(0, 19) + '.json';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function runHealthCheck() {

            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Controllo...';
            btn.disabled = true;
            
            setTimeout(() => {
                btn.innerHTML = '<i class="fas fa-check me-2"></i>Completato';
                btn.classList.add('btn-success');
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('btn-success');
                    btn.disabled = false;
                    location.reload();
                }, 1500);
            }, 2000);
        }
        

        function updateCurrentTime() {
            document.getElementById('current-time').textContent = new Date().toLocaleString();
        }
        
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);
        

        setInterval(refreshDebug, 30000);
    </script>
</body>
</html>